#ifndef PREFILTER_FRAG_H
#define PREFILTER_FRAG_H

#ifdef __cplusplus
extern "C" {
#endif

static const char PREFILTER_FRAG[] = "#version 330 core\n#define M_PI 3.1415926535897931\n#define M_TAU 6.2831853071795862\n#define M_INV_PI .3183098861837907\nvec3 M_Rotate3D(vec3 v,vec4 q){vec3 t=2.*cross(q.xyz,v);return v+q.w*t+cross(q.xyz,t);}mat3 M_OrthonormalBasis(vec3 n){float sgn=n.z>=0.?1.:-1.;float a=-1./(sgn+n.z);float b=n.x*n.y*a;vec3 t=vec3(1.+sgn*n.x*n.x*a,sgn*b,-sgn*n.x);vec3 bt=vec3(b,sgn+n.y*n.y*a,-n.y);return mat3(t,bt,n);}vec2 M_OctahedronWrap(vec2 val){return(1.-abs(val.yx))*mix(vec2(-1.),vec2(1.),vec2(greaterThanEqual(val.xy,vec2(0.))));}vec3 M_DecodeOctahedral(vec2 encoded){encoded=encoded*2.-1.;vec3 normal;normal.z=1.-abs(encoded.x)-abs(encoded.y);normal.xy=normal.z>=0.?encoded.xy:M_OctahedronWrap(encoded.xy);return normalize(normal);}vec2 M_EncodeOctahedral(vec3 normal){normal/=abs(normal.x)+abs(normal.y)+abs(normal.z);normal.xy=normal.z>=0.?normal.xy:M_OctahedronWrap(normal.xy);normal.xy=normal.xy*.5+.5;return normal.xy;}vec3 M_NormalScale(vec3 normal,float scale){normal.xy*=scale;normal.z=sqrt(1.-clamp(dot(normal.xy,normal.xy),0.,1.));return normal;}float M_HashIGN(vec2 pos){const vec3 magic=vec3(0.06711056,0.00583715,52.9829189);return fract(magic.z*fract(dot(pos,magic.xy)));}in vec3 vPosition;uniform samplerCube uTexCubemap;uniform float uResolution;uniform float uRoughness;out vec4 FragColor;float DistributionGGX(vec3 N,vec3 H,float roughness){float a=roughness*roughness;float a2=a*a;float NdotH=max(dot(N,H),0.);float NdotH2=NdotH*NdotH;float nom=a2;float denom=(NdotH2*(a2-1.)+1.);denom=M_PI*denom*denom;return nom/denom;}float RadicalInverse_VdC(uint bits){bits=(bits<<16u)|(bits>>16u);bits=((bits&0x55555555u)<<1u)|((bits&0xAAAAAAAAu)>>1u);bits=((bits&0x33333333u)<<2u)|((bits&0xCCCCCCCCu)>>2u);bits=((bits&0x0F0F0F0Fu)<<4u)|((bits&0xF0F0F0F0u)>>4u);bits=((bits&0x00FF00FFu)<<8u)|((bits&0xFF00FF00u)>>8u);return float(bits)*2.3283064365386963e-10;}vec2 Hammersley(uint i,uint N){return vec2(float(i)/float(N),RadicalInverse_VdC(i));}vec3 ImportanceSampleGGX(vec2 Xi,vec3 N,float roughness){float a=roughness*roughness;float phi=2.*M_PI*Xi.x;float cosTheta=sqrt((1.-Xi.y)/(1.+(a*a-1.)*Xi.y));float sinTheta=sqrt(1.-cosTheta*cosTheta);vec3 H;H.x=cos(phi)*sinTheta;H.y=sin(phi)*sinTheta;H.z=cosTheta;vec3 up=abs(N.z)<.999?vec3(0.,0.,1.):vec3(1.,0.,0.);vec3 tangent=normalize(cross(up,N));vec3 bitangent=cross(N,tangent);vec3 sampleVec=tangent*H.x+bitangent*H.y+N*H.z;return normalize(sampleVec);}void main(){vec3 N=normalize(vPosition);vec3 R=N;vec3 V=R;const uint SAMPLE_COUNT=1024u;vec3 prefilteredColor=vec3(0.);float totalWeight=0.;for(uint i=0u;i<SAMPLE_COUNT;++i){vec2 Xi=Hammersley(i,SAMPLE_COUNT);vec3 H=ImportanceSampleGGX(Xi,N,uRoughness);vec3 L=normalize(2.*dot(V,H)*H-V);float NdotL=max(dot(N,L),0.);if(NdotL>0.){float D=DistributionGGX(N,H,uRoughness);float NdotH=max(dot(N,H),0.);float HdotV=max(dot(H,V),0.);float pdf=D*NdotH/(4.*HdotV)+0.0001;float saTexel=4.*M_PI/(6.*uResolution*uResolution);float saSample=1./(float(SAMPLE_COUNT)*pdf+0.0001);float mipLevel=(uRoughness==0.)?0.:.5*log2(saSample/saTexel);prefilteredColor+=textureLod(uTexCubemap,L,mipLevel).rgb*NdotL;totalWeight+=NdotL;}}prefilteredColor=prefilteredColor/totalWeight;FragColor=vec4(prefilteredColor,1.);}";

#define PREFILTER_FRAG_SIZE 3200

#ifdef __cplusplus
}
#endif

#endif // PREFILTER_FRAG_H
