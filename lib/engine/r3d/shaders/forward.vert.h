#ifndef FORWARD_VERT_H
#define FORWARD_VERT_H

#ifdef __cplusplus
extern "C" {
#endif

static const char FORWARD_VERT[] = "#version 330 core\n#define BILLBOARD_NONE 0\n#define BILLBOARD_FRONT 1\n#define BILLBOARD_Y_AXIS 2\nvoid BillboardFront(inout mat4 model,mat4 invView){float scaleX=length(vec3(model[0]));float scaleY=length(vec3(model[1]));float scaleZ=length(vec3(model[2]));model[0]=vec4(invView[0].xyz*scaleX,0.);model[1]=vec4(invView[1].xyz*scaleY,0.);model[2]=vec4(invView[2].xyz*scaleZ,0.);}void BillboardFront(inout mat4 model,inout mat3 normal,mat4 invView){float scaleX=length(vec3(model[0]));float scaleY=length(vec3(model[1]));float scaleZ=length(vec3(model[2]));model[0]=vec4(invView[0].xyz*scaleX,0.);model[1]=vec4(invView[1].xyz*scaleY,0.);model[2]=vec4(invView[2].xyz*scaleZ,0.);normal[0]=invView[0].xyz;normal[1]=invView[1].xyz;normal[2]=invView[2].xyz;}void BillboardYAxis(inout mat4 model,mat4 invView){vec3 position=vec3(model[3]);float scaleX=length(vec3(model[0]));float scaleY=length(vec3(model[1]));float scaleZ=length(vec3(model[2]));vec3 upVector=normalize(vec3(model[1]));vec3 lookDirection=normalize(vec3(invView[3])-position);vec3 rightVector=normalize(cross(upVector,lookDirection));vec3 frontVector=normalize(cross(rightVector,upVector));model[0]=vec4(rightVector*scaleX,0.);model[1]=vec4(upVector*scaleY,0.);model[2]=vec4(frontVector*scaleZ,0.);}void BillboardYAxis(inout mat4 model,inout mat3 normal,mat4 invView){vec3 position=vec3(model[3]);float scaleX=length(vec3(model[0]));float scaleY=length(vec3(model[1]));float scaleZ=length(vec3(model[2]));vec3 upVector=normalize(vec3(model[1]));vec3 lookDirection=normalize(vec3(invView[3])-position);vec3 rightVector=normalize(cross(upVector,lookDirection));vec3 frontVector=normalize(cross(rightVector,upVector));model[0]=vec4(rightVector*scaleX,0.);model[1]=vec4(upVector*scaleY,0.);model[2]=vec4(frontVector*scaleZ,0.);normal[0]=rightVector;normal[1]=upVector;normal[2]=frontVector;\n}\n#define M_PI 3.1415926535897931\n#define M_TAU 6.2831853071795862\n#define M_INV_PI .3183098861837907\nvec3 M_Rotate3D(vec3 v,vec4 q){vec3 t=2.*cross(q.xyz,v);return v+q.w*t+cross(q.xyz,t);}mat3 M_OrthonormalBasis(vec3 n){float sgn=n.z>=0.?1.:-1.;float a=-1./(sgn+n.z);float b=n.x*n.y*a;vec3 t=vec3(1.+sgn*n.x*n.x*a,sgn*b,-sgn*n.x);vec3 bt=vec3(b,sgn+n.y*n.y*a,-n.y);return mat3(t,bt,n);}vec2 M_OctahedronWrap(vec2 val){return(1.-abs(val.yx))*mix(vec2(-1.),vec2(1.),vec2(greaterThanEqual(val.xy,vec2(0.))));}vec3 M_DecodeOctahedral(vec2 encoded){encoded=encoded*2.-1.;vec3 normal;normal.z=1.-abs(encoded.x)-abs(encoded.y);normal.xy=normal.z>=0.?encoded.xy:M_OctahedronWrap(encoded.xy);return normalize(normal);}vec2 M_EncodeOctahedral(vec3 normal){normal/=abs(normal.x)+abs(normal.y)+abs(normal.z);normal.xy=normal.z>=0.?normal.xy:M_OctahedronWrap(normal.xy);normal.xy=normal.xy*.5+.5;return normal.xy;}vec3 M_NormalScale(vec3 normal,float scale){normal.xy*=scale;normal.z=sqrt(1.-clamp(dot(normal.xy,normal.xy),0.,1.));return normal;}float M_HashIGN(vec2 pos){const vec3 magic=vec3(0.06711056,0.00583715,52.9829189);return fract(magic.z*fract(dot(pos,magic.xy)));}float PBR_DistributionGGX(float cosTheta,float alpha){float a=cosTheta*alpha;float k=alpha/(1.-cosTheta*cosTheta+a*a);return k*k*(1./M_PI);}float PBR_GeometryGGX(float NdotL,float NdotV,float roughness){return .5/mix(2.*NdotL*NdotV,NdotL+NdotV,roughness);}float PBR_SchlickFresnel(float u){float m=1.-u;float m2=m*m;return m2*m2*m;}vec3 PBR_ComputeF0(float metallic,float specular,vec3 albedo){float dielectric=.16*specular*specular;return mix(vec3(dielectric),albedo,vec3(metallic));\n}\n#define LIGHT_FORWARD_COUNT 8\n#define LIGHT_DIR 0\n#define LIGHT_SPOT 1\n#define LIGHT_OMNI 2\nvec3 L_Diffuse(float cLdotH,float cNdotV,float cNdotL,float roughness){float FD90_minus_1=2.*cLdotH*cLdotH*roughness-.5;float FdV=1.+FD90_minus_1*PBR_SchlickFresnel(cNdotV);float FdL=1.+FD90_minus_1*PBR_SchlickFresnel(cNdotL);return vec3(M_INV_PI*(FdV*FdL*cNdotL));}vec3 L_Specular(vec3 F0,float cLdotH,float cNdotH,float cNdotV,float cNdotL,float roughness){roughness=max(roughness,1e-3);float alphaGGX=roughness*roughness;float D=PBR_DistributionGGX(cNdotH,alphaGGX);float G=PBR_GeometryGGX(cNdotL,cNdotV,alphaGGX);float cLdotH5=PBR_SchlickFresnel(cLdotH);float F90=clamp(50.*F0.g,0.,1.);vec3 F=F0+(F90-F0)*cLdotH5;return cNdotL*D*F*G;}layout(location=0)in vec3 aPosition;layout(location=1)in vec2 aTexCoord;layout(location=2)in vec3 aNormal;layout(location=3)in vec4 aColor;layout(location=4)in vec4 aTangent;layout(location=5)in ivec4 aBoneIDs;layout(location=6)in vec4 aWeights;layout(location=10)in mat4 iMatModel;layout(location=14)in vec4 iColor;uniform sampler1D uTexBoneMatrices;uniform mat4 uMatLightVP[LIGHT_FORWARD_COUNT];uniform mat4 uMatInvView;uniform mat4 uMatNormal;uniform mat4 uMatModel;uniform mat4 uMatVP;uniform vec4 uAlbedoColor;uniform vec2 uTexCoordOffset;uniform vec2 uTexCoordScale;uniform bool uInstancing;uniform bool uSkinning;uniform int uBillboard;out vec3 vPosition;out vec2 vTexCoord;out vec4 vColor;out mat3 vTBN;out vec4 vPosLightSpace[LIGHT_FORWARD_COUNT];mat4 BoneMatrix(int boneID){int baseIndex=4*boneID;vec4 row0=texelFetch(uTexBoneMatrices,baseIndex+0,0);vec4 row1=texelFetch(uTexBoneMatrices,baseIndex+1,0);vec4 row2=texelFetch(uTexBoneMatrices,baseIndex+2,0);vec4 row3=texelFetch(uTexBoneMatrices,baseIndex+3,0);return transpose(mat4(row0,row1,row2,row3));}mat4 SkinMatrix(ivec4 boneIDs,vec4 weights){return weights.x*BoneMatrix(boneIDs.x)+weights.y*BoneMatrix(boneIDs.y)+weights.z*BoneMatrix(boneIDs.z)+weights.w*BoneMatrix(boneIDs.w);}void main(){mat4 matModel=uMatModel;mat3 matNormal=mat3(uMatNormal);if(uSkinning){mat4 sMatModel=SkinMatrix(aBoneIDs,aWeights);matModel=matModel*sMatModel;matNormal=matNormal*mat3(transpose(inverse(sMatModel)));}if(uInstancing){matModel=transpose(iMatModel)*matModel;matNormal=mat3(transpose(inverse(iMatModel)))*matNormal;}switch(uBillboard){case BILLBOARD_NONE:break;case BILLBOARD_FRONT:BillboardFront(matModel,matNormal,uMatInvView);break;case BILLBOARD_Y_AXIS:BillboardYAxis(matModel,matNormal,uMatInvView);break;}vec3 T=normalize(matNormal*aTangent.xyz);vec3 N=normalize(matNormal*aNormal);vec3 B=normalize(cross(N,T)*aTangent.w);vPosition=vec3(matModel*vec4(aPosition,1.));vTexCoord=uTexCoordOffset+aTexCoord*uTexCoordScale;vColor=aColor*iColor*uAlbedoColor;vTBN=mat3(T,B,N);for(int i=0;i<LIGHT_FORWARD_COUNT;i++){vPosLightSpace[i]=uMatLightVP[i]*vec4(vPosition,1.);}gl_Position=uMatVP*vec4(vPosition,1.);}";

#define FORWARD_VERT_SIZE 6382

#ifdef __cplusplus
}
#endif

#endif // FORWARD_VERT_H
