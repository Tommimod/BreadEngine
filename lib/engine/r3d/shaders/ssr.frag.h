#ifndef SSR_FRAG_H
#define SSR_FRAG_H

#ifdef __cplusplus
extern "C" {
#endif

static const char SSR_FRAG[] = "#version 330 core\n#define M_PI 3.1415926535897931\n#define M_TAU 6.2831853071795862\n#define M_INV_PI .3183098861837907\nvec3 M_Rotate3D(vec3 v,vec4 q){vec3 t=2.*cross(q.xyz,v);return v+q.w*t+cross(q.xyz,t);}mat3 M_OrthonormalBasis(vec3 n){float sgn=n.z>=0.?1.:-1.;float a=-1./(sgn+n.z);float b=n.x*n.y*a;vec3 t=vec3(1.+sgn*n.x*n.x*a,sgn*b,-sgn*n.x);vec3 bt=vec3(b,sgn+n.y*n.y*a,-n.y);return mat3(t,bt,n);}vec2 M_OctahedronWrap(vec2 val){return(1.-abs(val.yx))*mix(vec2(-1.),vec2(1.),vec2(greaterThanEqual(val.xy,vec2(0.))));}vec3 M_DecodeOctahedral(vec2 encoded){encoded=encoded*2.-1.;vec3 normal;normal.z=1.-abs(encoded.x)-abs(encoded.y);normal.xy=normal.z>=0.?encoded.xy:M_OctahedronWrap(encoded.xy);return normalize(normal);}vec2 M_EncodeOctahedral(vec3 normal){normal/=abs(normal.x)+abs(normal.y)+abs(normal.z);normal.xy=normal.z>=0.?normal.xy:M_OctahedronWrap(normal.xy);normal.xy=normal.xy*.5+.5;return normal.xy;}vec3 M_NormalScale(vec3 normal,float scale){normal.xy*=scale;normal.z=sqrt(1.-clamp(dot(normal.xy,normal.xy),0.,1.));return normal;}float M_HashIGN(vec2 pos){const vec3 magic=vec3(0.06711056,0.00583715,52.9829189);return fract(magic.z*fract(dot(pos,magic.xy)));}float PBR_DistributionGGX(float cosTheta,float alpha){float a=cosTheta*alpha;float k=alpha/(1.-cosTheta*cosTheta+a*a);return k*k*(1./M_PI);}float PBR_GeometryGGX(float NdotL,float NdotV,float roughness){return .5/mix(2.*NdotL*NdotV,NdotL+NdotV,roughness);}float PBR_SchlickFresnel(float u){float m=1.-u;float m2=m*m;return m2*m2*m;}vec3 PBR_ComputeF0(float metallic,float specular,vec3 albedo){float dielectric=.16*specular*specular;return mix(vec3(dielectric),albedo,vec3(metallic));}noperspective in vec2 vTexCoord;uniform sampler2D uTexColor;uniform sampler2D uTexAlbedo;uniform sampler2D uTexNormal;uniform sampler2D uTexORM;uniform sampler2D uTexDepth;uniform int uMaxRaySteps;uniform int uBinarySearchSteps;uniform float uRayMarchLength;uniform float uDepthThickness;uniform float uDepthTolerance;uniform float uEdgeFadeStart;uniform float uEdgeFadeEnd;uniform mat4 uMatView;uniform mat4 uMatInvProj;uniform mat4 uMatInvView;uniform mat4 uMatViewProj;uniform vec3 uViewPosition;out vec4 FragColor;vec3 ReconstructViewPosition(vec2 texCoord,float depth){vec4 ndcPos=vec4(texCoord*2.-1.,depth*2.-1.,1.);vec4 viewPos=uMatInvProj*ndcPos;return viewPos.xyz/viewPos.w;}vec3 ReconstructWorldPosition(vec2 texCoord,float depth){vec3 viewPos=ReconstructViewPosition(texCoord,depth);return(uMatInvView*vec4(viewPos,1.)).xyz;}vec2 WorldToScreenSpace(vec3 worldPos){vec4 projPos=uMatViewProj*vec4(worldPos,1.);projPos/=projPos.w;return projPos.xy*.5+.5;}bool IsOutOfScreen(vec2 uv){return any(greaterThan(uv,vec2(1.)))||any(lessThan(uv,vec2(0.)));}float ScreenEdgeFade(vec2 uv){vec2 fade=max(vec2(0.),abs(uv-.5)*2.-vec2(uEdgeFadeStart));fade=fade/(uEdgeFadeEnd-uEdgeFadeStart);return 1.-clamp(max(fade.x,fade.y),0.,1.);}vec3 BinarySearch(vec3 startPos,vec3 endPos){for(int i=0;i<uBinarySearchSteps;i++){vec3 midPos=(startPos+endPos)*.5;vec2 uv=WorldToScreenSpace(midPos);float sampledDepth=texture(uTexDepth,uv).r;vec3 sampledViewPos=ReconstructViewPosition(uv,sampledDepth);vec3 midViewPos=(uMatView*vec4(midPos,1.)).xyz;float depthDiff=sampledViewPos.z-midViewPos.z;if(depthDiff>-uDepthTolerance){endPos=midPos;}else{startPos=midPos;}}return endPos;}vec3 TraceReflectionRay(vec3 startPos,vec3 reflectionDir){float minStep=uRayMarchLength/float(uMaxRaySteps);float stepSize=minStep;vec3 currentPos=startPos;for(int i=0;i<uMaxRaySteps;i++){currentPos+=reflectionDir*stepSize;vec2 uv=WorldToScreenSpace(currentPos);if(IsOutOfScreen(uv))break;float sampledDepth=texture(uTexDepth,uv).r;vec3 sampledViewPos=ReconstructViewPosition(uv,sampledDepth);vec3 currentViewPos=(uMatView*vec4(currentPos,1.)).xyz;float depthDiff=sampledViewPos.z-currentViewPos.z;if(depthDiff>-uDepthTolerance&&depthDiff<uDepthThickness){currentPos=BinarySearch(startPos,currentPos);uv=WorldToScreenSpace(currentPos);vec3 color=texture(uTexColor,uv).rgb;float fade=ScreenEdgeFade(uv);return color*fade;}stepSize=max(depthDiff*.9,minStep);}return vec3(0.);}void main(){vec3 sceneColor=texture(uTexColor,vTexCoord).rgb;float depth=texture(uTexDepth,vTexCoord).r;if(depth>.999){FragColor=vec4(sceneColor,1.);return;}vec2 encodedNormal=texture(uTexNormal,vTexCoord).rg;vec3 albedo=texture(uTexAlbedo,vTexCoord).rgb;vec3 orm=texture(uTexORM,vTexCoord).rgb;float occlusion=orm.r;float roughness=orm.g;float metallic=orm.b;vec3 worldNormal=M_DecodeOctahedral(encodedNormal);vec3 worldPos=ReconstructWorldPosition(vTexCoord,depth);vec3 viewDir=normalize(worldPos-uViewPosition);vec3 reflectionDir=reflect(viewDir,worldNormal);if(dot(reflectionDir,worldNormal)<0.){FragColor=vec4(sceneColor,1.);return;}vec3 reflectionColor=TraceReflectionRay(worldPos,reflectionDir);float reflectionLuminance=dot(reflectionColor,vec3(.299,.587,.114));float sceneLuminance=dot(sceneColor,vec3(.299,.587,.114));float maxReflectionLuminance=sceneLuminance*4.;if(reflectionLuminance>maxReflectionLuminance){reflectionColor*=maxReflectionLuminance/reflectionLuminance;}float cNdotV=max(0.,dot(worldNormal,-viewDir));vec3 F0=PBR_ComputeF0(metallic,.5,albedo);vec3 F=F0+(1.-F0)*PBR_SchlickFresnel(cNdotV);vec3 specular=reflectionColor*F;float attenuation=1.-roughness;attenuation*=attenuation;specular*=attenuation;FragColor=vec4(sceneColor+specular,1.);}";

#define SSR_FRAG_SIZE 5367

#ifdef __cplusplus
}
#endif

#endif // SSR_FRAG_H
